<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ë§í•´ì£¼ëŠ” ì•±</title>
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;700&family=Noto+Sans+JP:wght@300;400;700&family=Space+Mono:wght@400;700&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #0a0a0f;
    --surface: #13131a;
    --border: #2a2a3a;
    --accent: #7c3aed;
    --accent2: #06b6d4;
    --jp-accent: #e11d48;
    --jp-accent2: #f97316;
    --text: #e8e8f0;
    --muted: #666680;
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    background: var(--bg);
    color: var(--text);
    font-family: 'Noto Sans KR', sans-serif;
    height: 100vh;
    display: flex;
    flex-direction: column;
    overflow: hidden;
  }

  body::before {
    content: '';
    position: fixed;
    top: -50%; left: -50%;
    width: 200%; height: 200%;
    background: radial-gradient(ellipse at 30% 20%, rgba(124,58,237,0.07) 0%, transparent 50%),
                radial-gradient(ellipse at 70% 80%, rgba(6,182,212,0.05) 0%, transparent 50%),
                radial-gradient(ellipse at 80% 20%, rgba(225,29,72,0.04) 0%, transparent 40%);
    pointer-events: none;
    z-index: 0;
  }

  header {
    position: relative; z-index: 1;
    padding: 16px 24px;
    border-bottom: 1px solid var(--border);
    display: flex; align-items: center; gap: 12px;
  }

  .logo-icon {
    width: 36px; height: 36px;
    background: linear-gradient(135deg, var(--accent), var(--accent2));
    border-radius: 10px;
    display: flex; align-items: center; justify-content: center;
    font-size: 18px;
  }

  h1 {
    font-family: 'Space Mono', monospace;
    font-size: 1.05rem;
    letter-spacing: 0.05em;
    flex: 1;
  }

  h1 span {
    background: linear-gradient(90deg, var(--accent), var(--accent2));
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
  }

  .mode-toggle {
    display: flex;
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 10px;
    overflow: hidden;
    padding: 3px;
    gap: 3px;
  }

  .mode-btn {
    padding: 6px 14px;
    border: none;
    border-radius: 7px;
    font-family: 'Noto Sans KR', sans-serif;
    font-size: 0.78rem;
    cursor: pointer;
    transition: all 0.25s;
    color: var(--muted);
    background: transparent;
    white-space: nowrap;
  }

  .mode-btn.active-kr {
    background: linear-gradient(135deg, var(--accent), var(--accent2));
    color: white;
  }

  .mode-btn.active-jp {
    background: linear-gradient(135deg, var(--jp-accent), var(--jp-accent2));
    color: white;
  }

  .settings {
    position: relative; z-index: 1;
    padding: 10px 24px;
    border-bottom: 1px solid var(--border);
    display: flex; gap: 14px; align-items: center; flex-wrap: wrap;
  }

  .setting-group {
    display: flex; align-items: center; gap: 7px;
  }

  label {
    font-size: 0.7rem;
    color: var(--muted);
    text-transform: uppercase;
    letter-spacing: 0.1em;
  }

  select, input[type=range] {
    background: var(--surface);
    border: 1px solid var(--border);
    color: var(--text);
    border-radius: 6px;
    padding: 4px 8px;
    font-size: 0.78rem;
    font-family: inherit;
    outline: none;
    cursor: pointer;
  }
  select:focus { border-color: var(--accent); }

  input[type=range] {
    -webkit-appearance: none;
    width: 75px; height: 4px;
    border-radius: 2px;
    background: var(--border);
    padding: 0;
  }
  input[type=range]::-webkit-slider-thumb {
    -webkit-appearance: none;
    width: 13px; height: 13px;
    border-radius: 50%;
    background: var(--accent);
    cursor: pointer;
  }

  .val-label {
    font-size: 0.72rem;
    color: var(--accent2);
    min-width: 26px;
    font-family: 'Space Mono', monospace;
  }

  .messages {
    position: relative; z-index: 1;
    flex: 1; overflow-y: auto;
    padding: 20px 24px;
    display: flex; flex-direction: column; gap: 14px;
  }

  .messages::-webkit-scrollbar { width: 4px; }
  .messages::-webkit-scrollbar-thumb { background: var(--border); border-radius: 2px; }

  .msg-group {
    display: flex;
    flex-direction: column;
    align-items: flex-end;
    gap: 6px;
    animation: fadeUp 0.3s ease;
  }

  .msg-bubble {
    max-width: 75%;
    padding: 12px 16px;
    font-size: 0.95rem;
    line-height: 1.6;
    border-radius: 16px 16px 4px 16px;
  }

  .bubble-kr {
    background: linear-gradient(135deg, rgba(124,58,237,0.22), rgba(6,182,212,0.12));
    border: 1px solid rgba(124,58,237,0.3);
  }

  .bubble-jp {
    background: linear-gradient(135deg, rgba(225,29,72,0.18), rgba(249,115,22,0.12));
    border: 1px solid rgba(225,29,72,0.3);
    font-family: 'Noto Sans JP', sans-serif;
  }

  .jp-label {
    display: flex;
    align-items: center;
    gap: 6px;
    margin-bottom: 6px;
  }

  .jp-badge {
    font-size: 0.65rem;
    color: var(--jp-accent2);
    letter-spacing: 0.08em;
    font-family: 'Space Mono', monospace;
    text-transform: uppercase;
  }

  .jp-text {
    font-size: 1rem;
    line-height: 1.8;
    color: #fde8ef;
  }

  .translating-badge {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    font-size: 0.78rem;
    color: var(--jp-accent2);
  }

  .dot-pulse {
    display: flex; gap: 3px; align-items: center;
  }
  .dot-pulse span {
    display: block; width: 4px; height: 4px;
    border-radius: 50%;
    background: var(--jp-accent2);
    animation: pulse 1s ease infinite;
  }
  .dot-pulse span:nth-child(2) { animation-delay: 0.2s; }
  .dot-pulse span:nth-child(3) { animation-delay: 0.4s; }

  @keyframes pulse {
    0%, 100% { opacity: 0.2; transform: scale(0.8); }
    50% { opacity: 1; transform: scale(1.1); }
  }

  .msg-actions {
    display: flex; gap: 6px; align-items: center;
    margin-top: 8px;
  }

  .action-btn {
    background: rgba(124,58,237,0.15);
    border: 1px solid rgba(124,58,237,0.35);
    color: var(--accent2);
    border-radius: 20px;
    padding: 3px 10px;
    font-size: 0.7rem;
    cursor: pointer;
    transition: all 0.2s;
    font-family: inherit;
  }
  .action-btn:hover { background: rgba(124,58,237,0.35); }

  .action-btn.jp-btn {
    background: rgba(225,29,72,0.12);
    border-color: rgba(225,29,72,0.35);
    color: var(--jp-accent2);
  }
  .action-btn.jp-btn:hover { background: rgba(225,29,72,0.3); }

  .speaking-indicator {
    display: flex; align-items: center; gap: 3px; padding: 3px 6px;
  }
  .speaking-indicator span {
    display: block; width: 3px; height: 11px;
    background: var(--accent2);
    border-radius: 2px;
    animation: soundwave 0.8s ease infinite;
  }
  .speaking-indicator span:nth-child(2) { animation-delay: 0.1s; height: 17px; }
  .speaking-indicator span:nth-child(3) { animation-delay: 0.2s; height: 13px; }
  .speaking-indicator span:nth-child(4) { animation-delay: 0.15s; height: 19px; }
  .speaking-indicator span:nth-child(5) { animation-delay: 0.05s; height: 9px; }

  @keyframes soundwave {
    0%, 100% { transform: scaleY(0.4); opacity: 0.5; }
    50% { transform: scaleY(1); opacity: 1; }
  }

  @keyframes fadeUp {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
  }

  .empty-state {
    flex: 1;
    display: flex; flex-direction: column;
    align-items: center; justify-content: center;
    gap: 14px; color: var(--muted); text-align: center;
  }

  .empty-icon { font-size: 2.8rem; opacity: 0.25; }
  .empty-state p { font-size: 0.88rem; line-height: 1.8; }

  .input-area {
    position: relative; z-index: 1;
    padding: 10px 24px 12px;
    border-bottom: 1px solid var(--border);
    display: flex; gap: 10px; align-items: flex-end;
  }

  .input-wrapper {
    flex: 1;
    position: relative;
  }

  textarea {
    width: 100%;
    background: var(--surface);
    border: 1px solid var(--border);
    color: var(--text);
    border-radius: 12px;
    padding: 12px 16px;
    font-size: 0.95rem;
    font-family: 'Noto Sans KR', sans-serif;
    resize: none;
    outline: none;
    line-height: 1.5;
    max-height: 120px;
    transition: border-color 0.2s;
  }

  textarea:focus { border-color: var(--accent); }
  textarea::placeholder { color: var(--muted); }

  .mode-indicator {
    position: absolute;
    bottom: -20px; left: 4px;
    font-size: 0.67rem;
    color: var(--muted);
    letter-spacing: 0.05em;
    transition: color 0.3s;
  }

  .mode-indicator.jp { color: var(--jp-accent2); }

  .send-btn {
    width: 46px; height: 46px;
    border: none;
    border-radius: 12px;
    color: white;
    font-size: 1.1rem;
    cursor: pointer;
    display: flex; align-items: center; justify-content: center;
    transition: all 0.25s;
    flex-shrink: 0;
  }

  .send-btn.kr-mode { background: linear-gradient(135deg, var(--accent), var(--accent2)); }
  .send-btn.jp-mode { background: linear-gradient(135deg, var(--jp-accent), var(--jp-accent2)); }

  .send-btn:hover { transform: scale(1.05); opacity: 0.9; }
  .send-btn:active { transform: scale(0.97); }
  .send-btn:disabled { opacity: 0.4; cursor: not-allowed; transform: none; }

  .notice {
    position: relative; z-index: 1;
    margin: 0 24px;
    padding: 9px 14px;
    background: rgba(239,68,68,0.1);
    border: 1px solid rgba(239,68,68,0.3);
    border-radius: 8px;
    font-size: 0.8rem;
    color: #fca5a5;
    display: none;
  }
</style>
</head>
<body>

<header>
  <div class="logo-icon">ğŸ”Š</div>
  <h1>VOICE<span>CHAT</span></h1>
  <div class="mode-toggle">
    <button class="mode-btn active-kr" id="modKr" onclick="setMode('kr')">ğŸ‡°ğŸ‡· í•œêµ­ì–´</button>
    <button class="mode-btn" id="modJp" onclick="setMode('jp')">ğŸ‡¯ğŸ‡µ í•œâ†’ì¼ ë²ˆì—­</button>
  </div>
</header>

<div class="input-area">
  <div class="input-wrapper">
    <div class="mode-indicator" id="modeIndicator">ğŸ‡°ğŸ‡· í•œêµ­ì–´ ëª¨ë“œ</div>
    <textarea id="textInput" placeholder="ë§í•˜ê³  ì‹¶ì€ ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”..." rows="1"></textarea>
  </div>
  <button class="send-btn kr-mode" id="sendBtn">â–¶</button>
</div>

<div class="settings">
  <div class="setting-group">
    <label>ëª©ì†Œë¦¬</label>
    <select id="voiceSelect"><option value="">ë¡œë”©ì¤‘...</option></select>
  </div>
  <div class="setting-group">
    <label>ì†ë„</label>
    <input type="range" id="rateRange" min="0.5" max="2" step="0.1" value="1">
    <span class="val-label" id="rateVal">1.0</span>
  </div>
  <div class="setting-group">
    <label>ìŒë†’ì´</label>
    <input type="range" id="pitchRange" min="0" max="2" step="0.1" value="1">
    <span class="val-label" id="pitchVal">1.0</span>
  </div>
  <div class="setting-group">
    <label>ë³¼ë¥¨</label>
    <input type="range" id="volRange" min="0" max="1" step="0.05" value="1">
    <span class="val-label" id="volVal">1.0</span>
  </div>
</div>

<div class="notice" id="notice"></div>

<div class="messages" id="messages">
  <div class="empty-state" id="emptyState">
    <div class="empty-icon">ğŸ™ï¸</div>
    <p>í•œêµ­ì–´ë¡œ ì…ë ¥í•˜ë©´ ìŒì„±ìœ¼ë¡œ ì½ì–´ë“œë¦½ë‹ˆë‹¤<br><br>
    <span style="color: #f97316; font-size:0.82rem">ğŸ‡¯ğŸ‡µ í•œâ†’ì¼ ë²ˆì—­ ëª¨ë“œì—ì„œëŠ”<br>ì¼ë³¸ì–´ë¡œ ë²ˆì—­ í›„ ì¼ë³¸ì–´ ìŒì„±ìœ¼ë¡œ ì¬ìƒë©ë‹ˆë‹¤</span></p>
  </div>
</div>

<script>
  const synth = window.speechSynthesis;
  let voices = [];
  let currentMode = 'kr';
  let isSpeaking = false;

  const voiceSelect = document.getElementById('voiceSelect');
  const rateRange = document.getElementById('rateRange');
  const pitchRange = document.getElementById('pitchRange');
  const volRange = document.getElementById('volRange');
  const rateVal = document.getElementById('rateVal');
  const pitchVal = document.getElementById('pitchVal');
  const volVal = document.getElementById('volVal');
  const textInput = document.getElementById('textInput');
  const sendBtn = document.getElementById('sendBtn');
  const messages = document.getElementById('messages');
  const emptyState = document.getElementById('emptyState');
  const notice = document.getElementById('notice');
  const modeIndicator = document.getElementById('modeIndicator');

  function loadVoices() {
    voices = synth.getVoices();
    updateVoiceList();
  }

  function updateVoiceList() {
    voiceSelect.innerHTML = '';
    const targetLang = currentMode === 'jp' ? 'ja' : 'ko';
    const labelPrimary = currentMode === 'jp' ? 'ğŸ‡¯ğŸ‡µ ì¼ë³¸ì–´' : 'ğŸ‡°ğŸ‡· í•œêµ­ì–´';

    const primary = voices.filter(v => v.lang.startsWith(targetLang));
    const other = voices.filter(v => !v.lang.startsWith(targetLang));

    if (primary.length > 0) {
      const g = document.createElement('optgroup');
      g.label = labelPrimary;
      primary.forEach(v => {
        const opt = document.createElement('option');
        opt.value = voices.indexOf(v);
        opt.textContent = v.name;
        g.appendChild(opt);
      });
      voiceSelect.appendChild(g);
    }

    if (other.length > 0) {
      const g = document.createElement('optgroup');
      g.label = 'ğŸŒ ê¸°íƒ€';
      other.forEach(v => {
        const opt = document.createElement('option');
        opt.value = voices.indexOf(v);
        opt.textContent = `${v.name} (${v.lang})`;
        g.appendChild(opt);
      });
      voiceSelect.appendChild(g);
    }

    if (voices.length === 0) voiceSelect.innerHTML = '<option>ì‚¬ìš© ë¶ˆê°€</option>';
  }

  if (synth.onvoiceschanged !== undefined) synth.onvoiceschanged = loadVoices;
  loadVoices();

  function setMode(mode) {
    currentMode = mode;
    document.getElementById('modKr').className = 'mode-btn' + (mode === 'kr' ? ' active-kr' : '');
    document.getElementById('modJp').className = 'mode-btn' + (mode === 'jp' ? ' active-jp' : '');
    sendBtn.className = 'send-btn ' + (mode === 'jp' ? 'jp-mode' : 'kr-mode');
    modeIndicator.textContent = mode === 'jp' ? 'ğŸ‡¯ğŸ‡µ í•œâ†’ì¼ ë²ˆì—­ ëª¨ë“œ' : 'ğŸ‡°ğŸ‡· í•œêµ­ì–´ ëª¨ë“œ';
    modeIndicator.className = 'mode-indicator' + (mode === 'jp' ? ' jp' : '');
    textInput.placeholder = mode === 'jp'
      ? 'í•œêµ­ì–´ë¡œ ì…ë ¥í•˜ë©´ ì¼ë³¸ì–´ë¡œ ë²ˆì—­ í›„ ìŒì„± ì¬ìƒ...'
      : 'ë§í•˜ê³  ì‹¶ì€ ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”...';
    updateVoiceList();
  }

  rateRange.oninput = () => rateVal.textContent = parseFloat(rateRange.value).toFixed(1);
  pitchRange.oninput = () => pitchVal.textContent = parseFloat(pitchRange.value).toFixed(1);
  volRange.oninput = () => volVal.textContent = parseFloat(volRange.value).toFixed(2);

  textInput.addEventListener('input', function() {
    this.style.height = 'auto';
    this.style.height = Math.min(this.scrollHeight, 120) + 'px';
  });

  textInput.addEventListener('keydown', (e) => {
    if (e.key === 'Enter' && !e.shiftKey) {
      e.preventDefault();
      handleSend();
    }
  });

  sendBtn.addEventListener('click', () => {
    if (isSpeaking) {
      synth.cancel();
      setSpeakingState(false);
    } else {
      handleSend();
    }
  });

  async function handleSend() {
    const text = textInput.value.trim();
    if (!text || isSpeaking) return;

    emptyState.style.display = 'none';
    textInput.value = '';
    textInput.style.height = 'auto';

    if (currentMode === 'kr') {
      const group = addMessageGroup(text, false);
      speakText(text, 'ko');
    } else {
      const group = addMessageGroup(text, true);
      const translated = await translateToJapanese(text, group);
      if (translated) speakText(translated, 'ja');
    }
  }

  async function translateToJapanese(koreanText, group) {
    try {
      // MyMemory ë¬´ë£Œ ë²ˆì—­ API (CORS OK, APIí‚¤ ë¶ˆí•„ìš”)
      const url = 'https://api.mymemory.translated.net/get?q=' + encodeURIComponent(koreanText) + '&langpair=ko|ja';
      const response = await fetch(url);
      if (!response.ok) throw new Error('ë²ˆì—­ API ì˜¤ë¥˜ (' + response.status + ')');
      const data = await response.json();
      const translated = data.responseData && data.responseData.translatedText
        ? data.responseData.translatedText.trim() : null;

      if (translated && data.responseStatus === 200) {
        updateJpBubble(group, translated);
        return translated;
      } else {
        throw new Error(data.responseDetails || 'ë²ˆì—­ ê²°ê³¼ ì—†ìŒ');
      }
    } catch (err) {
      console.error(err);
      showNotice('ë²ˆì—­ ì¤‘ ì˜¤ë¥˜: ' + err.message);
      if (group._jpBubble) group._jpBubble.remove();
    }
    return null;
  }

  function speakText(text, lang) {
    synth.cancel();

    // í•­ìƒ ìµœì‹  voices ê°€ì ¸ì˜¤ê¸°
    const allVoices = synth.getVoices();
    if (allVoices.length > 0) voices = allVoices;

    const utterance = new SpeechSynthesisUtterance(text);
    const targetLangTag = lang === 'ja' ? 'ja-JP' : 'ko-KR';
    utterance.lang = targetLangTag;

    const targetPrefix = lang === 'ja' ? 'ja' : 'ko';
    const matchingVoices = voices.filter(v => v.lang.startsWith(targetPrefix));

    if (lang === 'ja') {
      // ì¼ë³¸ì–´ ëª¨ë“œ: ë“œë¡­ë‹¤ìš´ ë¬´ì‹œí•˜ê³  í•­ìƒ ì¼ë³¸ì–´ ìŒì„± ê°•ì œ
      if (matchingVoices.length > 0) {
        utterance.voice = matchingVoices[0];
      }
    } else {
      const selectedIndex = voiceSelect.value;
      const selectedVoice = voices[selectedIndex];
      if (selectedVoice && selectedVoice.lang.startsWith(targetPrefix)) {
        utterance.voice = selectedVoice;
      } else if (matchingVoices.length > 0) {
        utterance.voice = matchingVoices[0];
      }
    }

    utterance.rate = parseFloat(rateRange.value);
    utterance.pitch = parseFloat(pitchRange.value);
    utterance.volume = parseFloat(volRange.value);
    utterance.onstart = () => setSpeakingState(true);
    utterance.onend = utterance.onerror = () => setSpeakingState(false);
    synth.speak(utterance);
  }

  function setSpeakingState(speaking) {
    isSpeaking = speaking;
    sendBtn.textContent = speaking ? 'â¹' : 'â–¶';
  }

  function addMessageGroup(krText, withJpLoading) {
    const group = document.createElement('div');
    group.className = 'msg-group';

    // Korean bubble
    const krBubble = document.createElement('div');
    krBubble.className = 'msg-bubble bubble-kr';
    krBubble.appendChild(document.createTextNode(krText));

    const krActions = document.createElement('div');
    krActions.className = 'msg-actions';
    krActions.innerHTML = '<div class="speaking-indicator"><span></span><span></span><span></span><span></span><span></span></div>';
    const krReplay = document.createElement('button');
    krReplay.className = 'action-btn';
    krReplay.textContent = 'â†º í•œêµ­ì–´ ì¬ìƒ';
    krReplay.onclick = () => speakText(krText, 'ko');
    krActions.appendChild(krReplay);
    krBubble.appendChild(krActions);
    group.appendChild(krBubble);

    if (withJpLoading) {
      const jpBubble = document.createElement('div');
      jpBubble.className = 'msg-bubble bubble-jp';

      const lbl = document.createElement('div');
      lbl.className = 'jp-label';
      lbl.innerHTML = '<span>ğŸ‡¯ğŸ‡µ</span><span class="jp-badge">ë²ˆì—­ ì¤‘</span>';
      jpBubble.appendChild(lbl);

      const loading = document.createElement('div');
      loading.className = 'translating-badge';
      loading.innerHTML = '<div class="dot-pulse"><span></span><span></span><span></span></div><span>ì¼ë³¸ì–´ë¡œ ë²ˆì—­í•˜ëŠ” ì¤‘...</span>';
      jpBubble.appendChild(loading);

      group._jpBubble = jpBubble;
      group.appendChild(jpBubble);
    }

    messages.appendChild(group);
    messages.scrollTop = messages.scrollHeight;
    return group;
  }

  function updateJpBubble(group, jpText) {
    if (!group._jpBubble) return;
    const jpBubble = group._jpBubble;
    jpBubble.innerHTML = '';

    const lbl = document.createElement('div');
    lbl.className = 'jp-label';
    lbl.innerHTML = '<span>ğŸ‡¯ğŸ‡µ</span><span class="jp-badge">ì¼ë³¸ì–´ ë²ˆì—­</span>';
    jpBubble.appendChild(lbl);

    const textDiv = document.createElement('div');
    textDiv.className = 'jp-text';
    textDiv.textContent = jpText;
    jpBubble.appendChild(textDiv);

    const actions = document.createElement('div');
    actions.className = 'msg-actions';
    actions.innerHTML = '<div class="speaking-indicator"><span></span><span></span><span></span><span></span><span></span></div>';
    const jpReplay = document.createElement('button');
    jpReplay.className = 'action-btn jp-btn';
    jpReplay.textContent = 'â†º ì¼ë³¸ì–´ ì¬ìƒ';
    jpReplay.onclick = () => speakText(jpText, 'ja');
    actions.appendChild(jpReplay);
    jpBubble.appendChild(actions);

    messages.scrollTop = messages.scrollHeight;
  }

  function showNotice(msg) {
    notice.textContent = msg;
    notice.style.display = 'block';
    setTimeout(() => notice.style.display = 'none', 5000);
  }
</script>
</body>
</html>
